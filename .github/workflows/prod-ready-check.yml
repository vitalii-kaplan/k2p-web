name: prod-compose-check

on:
  push:

jobs:
  prod-compose-check:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4

      - name: Create CI .env from example
        run: |
          cp .env.example .env
          cat >> .env <<'EOF'
          DJANGO_DEBUG=0
          DJANGO_SECRET_KEY=ci-K2pWeb-2026-ProdCheck-LongRandomKey-7vN4pQ2mX9sL8tR6cH3dJ1
          DJANGO_ALLOWED_HOSTS=127.0.0.1,localhost
          CSRF_TRUSTED_ORIGINS=http://127.0.0.1:8000,http://localhost:8000
          DB_ENGINE=postgres
          DB_NAME=k2pweb
          DB_USER=k2pweb
          DB_PASSWORD=k2pweb_password
          DB_HOST=postgres
          DB_PORT=5432
          EOF

      - name: Create CI nginx basic-auth file
        run: |
          mkdir -p deploy/nginx
          HASH="$(openssl passwd -apr1 ci-password)"
          printf 'ci:%s\n' "$HASH" > deploy/nginx/.htpasswd

      - name: Create CI TLS certs for nginx
        run: |
          sudo mkdir -p /opt/k2pweb/certs
          sudo openssl req -x509 -nodes -newkey rsa:2048 \
            -keyout /opt/k2pweb/certs/origin.key \
            -out /opt/k2pweb/certs/origin.pem \
            -days 2 -subj "/CN=127.0.0.1"
          sudo chmod 644 /opt/k2pweb/certs/origin.pem
          sudo chmod 600 /opt/k2pweb/certs/origin.key

      - name: Run production compose readiness check
        run: |
          chmod +x ./scripts/prod-ready-check.sh
          COMPOSE_FILE=docker-compose.prod.nginx.yml API_URL=https://127.0.0.1 START_WORKER=1 REQUIRE_TLS=1 CURL_INSECURE=1 ./scripts/prod-ready-check.sh

      - name: Show compose logs on failure
        if: failure()
        run: docker compose -f docker-compose.prod.nginx.yml logs --tail=200 || true
